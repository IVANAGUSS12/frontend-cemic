<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CEMIC · Oficina Virtual de Autorizaciones</title>
  <style>
    :root{--verde:#064427;--gris:#f5f7f6;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--gris);font-family:Arial,system-ui,sans-serif}
    .wrap{max-width:760px;margin:28px auto;padding:0 16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.08);overflow:hidden}
    .head{background:var(--verde);color:#fff;padding:20px 24px}
    .head h1{margin:0;font-size:22px}
    .body{padding:22px 24px}
    label{font-weight:700;font-size:14px;margin:12px 0 6px;display:block}
    input,textarea,select{width:100%;border:1px solid #d6ddd9;padding:12px;border-radius:10px;font-size:15px}
    textarea{min-height:110px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:720px){.row{grid-template-columns:1fr}}
    .note{font-size:12px;color:#4a5a54;margin-top:8px}
    .btn{background:var(--verde);color:#fff;border:0;padding:14px;border-radius:12px;width:100%;font-weight:700;cursor:pointer;margin-top:16px}
    .btn[disabled]{opacity:.7;cursor:not-allowed}
    .wpp{position:fixed;right:18px;bottom:18px;background:#25D366;color:#fff;padding:12px 14px;border-radius:999px;text-decoration:none;font-weight:700;box-shadow:0 8px 18px rgba(0,0,0,.18)}
    .help{font-size:12px;color:#50615b;margin-top:6px}
    .social{display:inline-flex;align-items:center;gap:8px;font-weight:600;color:#064427;text-decoration:none;background:#eef7f1;padding:10px 12px;border-radius:10px}
    .social:hover{background:#e3f0e8}
    .social svg{width:18px;height:18px}
    .hint{font-size:12px;color:#4a5a54;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head"><h1>CEMIC · Oficina Virtual de Autorizaciones</h1></div>
      <div class="body">
        <form id="form" novalidate>
          <div class="row">
            <div>
              <label>Nombre y apellido *</label>
              <input name="nombre" required placeholder="Ej: Juan Pérez">
            </div>
            <div>
              <label>DNI *</label>
              <input name="dni" required inputmode="numeric" placeholder="Ej: 12345678">
            </div>
          </div>

          <div class="row">
            <div>
              <label>Correo electrónico *</label>
              <input type="email" name="email" required placeholder="paciente@mail.com">
            </div>
            <div>
              <label>Teléfono *</label>
              <input name="telefono" required inputmode="tel" placeholder="11 5555-5555">
            </div>
          </div>

          <div class="row">
            <div>
              <label>Cobertura médica *</label>
              <input list="obrasList" name="cobertura" id="cobertura" required placeholder="Escribí para buscar o ingresá manualmente">
              <datalist id="obrasList"></datalist>
              <div class="help">Escribí para buscar. Si no aparece, ingresá el nombre tal como figura en tu credencial.</div>
            </div>
            <div>
              <label>Médico tratante *</label>
              <input list="medicosList" name="medico" id="medico" required placeholder="Escribí para buscar o ingresá manualmente">
              <datalist id="medicosList"></datalist>
              <div class="help">Escribí parte del apellido/nombre para filtrar. Si no figura, ingresalo manualmente.</div>
            </div>
          </div>

          <!-- NUEVO: Fecha de cirugía (opcional) -->
          <div class="row">
            <div>
              <label for="fecha_cx">Fecha de cirugía (opcional)</label>
              <input id="fecha_cx" name="fecha_cx" type="date" />
            </div>
          </div>

          <label>Foto de orden médica *</label>
          <input type="file" name="orden_medica" accept="image/*,application/pdf" required>

          <label>Foto de DNI *</label>
          <input type="file" name="dni_file" accept="image/*,application/pdf" required>

          <label>Foto de credencial *</label>
          <input type="file" name="credencial" accept="image/*,application/pdf" required>

          <!-- NUEVO: Orden de pedido de materiales (opcional) -->
          <label for="orden_materiales">Orden de pedido de materiales (opcional)</label>
          <input id="orden_materiales" name="orden_materiales" type="file" accept=".jpg,.jpeg,.png,.pdf" />
          <div class="hint">Podés subir JPG, PNG o PDF. Máx. 15 MB.</div>

          <label>Observaciones</label>
          <textarea name="observaciones" placeholder="Comentarios adicionales"></textarea>

          <div class="note">Formatos permitidos: JPG/PNG/PDF. Máximo 15 MB por archivo.</div>

          <button class="btn" id="sendBtn" type="submit">Enviar solicitud</button>
        </form>

        <div style="margin-top:14px">
          <a class="social" href="https://www.instagram.com/cemic_hu/?hl=es" target="_blank" rel="noopener">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <rect x="2.5" y="2.5" width="19" height="19" rx="5" stroke="#064427" stroke-width="1.8"/>
              <circle cx="12" cy="12" r="4.2" stroke="#064427" stroke-width="1.8"/>
              <circle cx="17.4" cy="6.6" r="1.2" fill="#064427"/>
            </svg>
            Instagram CEMIC
          </a>
        </div>
      </div>
    </div>
  </div>

  <a class="wpp" href="https://wa.me/5491155922359" target="_blank" rel="noopener">WhatsApp</a>

  <script>
    // ===== URL /exec del Apps Script =====
    const GS_URL = "https://script.google.com/macros/s/AKfycbxgsmf5t_LYrTLu9HvuokiOzaGBVevtK6oY26D0Au7zi_Z6zJhLUjBa_ydne70DwEOZ/exec";
  </script>

  <!-- === NUEVO: Switch para back de PRUEBAS (no cambia lo visual) === -->
  <script>
    // En tu sitio de PRUEBAS poné true. En el oficial dejalo false hasta el corte.
    window.USE_NEW_API = true;

    // Detecta entorno local vs Netlify (para desarrollo local)
    const _isLocal = location.hostname === '127.0.0.1' || location.hostname === 'localhost';
    // En PRUEBAS (Netlify) usamos proxy '/api'. En local (dev) pegamos a 127.0.0.1:8000
    window.NEW_API_URL = _isLocal ? 'http://127.0.0.1:8000/api' : '/api';
  </script>

  <script>
    // === Listas (se rellenan desde arrays más abajo) ===
    const MEDICOS = [
      "ABALO EDUARDO","ADROGUE LUIS","BARBIERI PABLO","CARRIZO JUAN","CHAVEZ ARIEL","CONSTANZA EDUARDO",
      "CORDOBA ALEJANDRA","DE ZAVALIA MAXIMO","DEIMUNDO MARCOS","DEVOTO MATIAS","GOBBI ENRIQUE",
      "GRANDOLI FERNANDO","IGLESIAS ALEJANDRO","MALLEA ANDRES","MENINATO MARCOS","MOUNIER CARLOS",
      "ORTIZ EZEQUIEL","PEREA AGUSTIN","PINOTTI NORBERTO","SANNA HERNAN","SERE IGNACIO",
      "TORGA SPAK ROGER","VALENTINI ROBERTO","VILLA NATALIA","YAVEN IGNACIO","YEREGUI SANTIAGO"
    ].sort((a,b)=>a.localeCompare(b));

    const OBRAS = [
      "ACMED S.A", "AMEPBA", "ANDAR", "APRES S.A.", "APSOT", "ASOC.MEDICA DEL DPTO. CASTELLANOS", "ASOCIACION MUTUAL RURALISTA", "ASOCIACION MUTUAL SANCOR SALUD", "ASOCIART S.A.(ART)", "AVALIAN", "BAJA COLEGIO GREMIAL CHACO", "BAJA RED ARG.DE SALUD CON DE COOP", "BERKLEY INTERNACIONAL S.A.(ART)", "BS.AS. SKIN S.A.", "CAJA NOTARIAL", "CAJA NOTARIAL DE ACCION SOCIAL", "CEMIC", "CEMIC PLAN 200", "CEMIC PLAN 300", "CEMIC PLAN 3500", "CEMIC PLAN 400", "CEMIC PLAN 6000", "CEMIC PLAN 9000", "CEMIC PLAN-500", "CEMIC PLAN-5050", "CEMIC PLAN-600", "CEMIC PLAN-700 EXCEP 750", "CEMIC PLAN-750 751", "CENTRO DE FERTILIDAD BS.AS.", "CENTRO MEDICO DE MAR DEL PLATA", "CENTRO MEDICO PUEYRREDON", "CINME S.A.", "CIRC.MED.LOMAS ZAMORA", "CIRCULO MEDICO DE LA MATANZA", "CLINICA SAN MARTIN SALUD S.A", "CLUB ATLETICO BOCA JUNIORS", "COBE INT.DE MEDICINA ASIST.S.A", "COBENSIL S.A", "COLEGIO ESCRIBANOS PROVINCIA", "CONEXA", "CONFERENCIA EPISCOPAL ARGENTINA", "CONVENIO PARTICULAR", "CORPORACION ASISTENCIAL", "CYNTHIOS SALUD S.A", "DASMI", "DIREC.OBRAS SOCIAL PCIA. SAN JUAN", "ENSALUD", "ENSAYOS CLINICOS", "EXPERTA ART S.A", "FAMYL", "FED.CLIN. Y SANATORIOS MISIONES", "FERTIMED S.A.", "FETEM", "FUND. FUNDAMOS PARA ASIS. PSIQ.", "FUND.SERV.SOC.TECHINT", "FUNDACION MEDICA DE MAR DEL PLATA", "G MAS", "GALENO", "GENERAR SALUD", "GENESEN", "GERMED S.A.", "HEALTH MEDICAL", "HHS HOME HEALTH SERVICES", "HOPE", "HOSPITAL ALEMAN ASOCIACION CIVIL", "HOSPITAL BRITANICO", "HOSPITAL PRIVADO DE CORDOBA", "INSSJYP GRAL", "INSSJYP TX RENAL", "INST. DE INV. METABOLICAS (IDIM)", "INST.O.SOCIAL EMPLEADO PROVINCIAL", "INST.SEG.SOC. CHUBUT", "INST.SEG.SOC.Y SEG CHUBUT", "INSTITUTO TOMAS DEVOTO", "INSTITUTO ZALDIVAR", "INVESTIGACIONES VASCULARES", "IOSCOR", "IVI BUENOS AIRES S.A.", "JERARQUICOS SALUD", "LA HOLANDO ART", "LA SEGUNDA ART", "LUIS PASTEUR", "MEDICARDIO", "MEDICUS", "MEDICUS OBRA SOCIAL FORD ARG.", "MEDIFE", "MEDIN S.A.DE SERV.MED.ASIST.", "MEDINTH S.A. - VICTORIA ART", "MEDIPREMIUM", "MEDITAR S.A", "MITA", "MUTUAL FEDERADA 25 DE JUNIO", "MUTUAL MEDICA CONCORDIA", "N O.S TRAB. PETROLEO Y GAS PRIV", "NEOIAGENES HOSPITALARIOS", "NEOIMAGENES PRIVADO", "NOCEMIC", "NUEVA OBRA SOCIAL DE EJECUTIVOS", "NUTRIMED", "O.S. DE GUINCHEROS Y MAQUINISTAS", "O.S. PERSONAL IND. MADERERA", "O.S.A.R.P.Y H", "O.S.AGENTES DE PROP.MED DE LA RA", "O.S.C.T.C.P.(UTA)", "O.S.D.I.P.P.", "O.S.DEL PERS. DE LA SANIDAD ARG.", "O.S.PERS.DE LA ACT.CERVECERA AFIN", "O.S.SUPER.IND.METALMECANICA RA", "O.S.T.P.C.H.E.P.Y.A.R.A.", "OBRA SOCIAL DE ACTORES", "OBRA SOCIAL DE EJECUTIVOS", "OBRA SOCIAL MUNIC. MATANZA", "OBSBA (FONDO COMPENSADOR)", "OMINT", "OPDEA", "OS DE LAS ASOC DE EMP DE FARMACIA", "OSAM SALUD", "OSDE", "OSFATUN", "OSMATA", "OSME", "OSPE", "OSPIDA", "OSPOCE AMCI", "OSPOCE INTEGRAL", "OSRJA", "OSSACRA", "OSSEG", "OSUTHGRA", "PALIAR S.A.", "PARTICULAR", "PARTICULAR CONSULTAS", "PAT. CABOTAJE DE RIOS Y PUERTOS", "PEDIATRIC CARE SRL", "PODER JUDICIAL", "PREMEDIC GRUPO D.D.M SA", "PREVENCION SALUD S.A.", "PRIVAMED", "PSORIAHUE", "RECURSOS HUMANOS", "ROI", "SANATORIO JUNIN", "SANCOR (PLANES DERIVADOS)", "SEMPRE", "SER.UNIV.MED.ASIST.", "SERPACON", "SERV.DE OS.DE LA UNIV.NAC.DEL SUR", "SERV.MUNI.CIU.SGO DEL ESTERO", "SMAUNSE", "SU MEDICINA ASISTENCIAL S.A", "SWISS MEDICAL", "SWISS MEDICAL ART", "UNIMED S.R.L.", "VISITAR S.R.L."

    ].sort((a,b)=>a.localeCompare(b));

    const dlMed = document.getElementById('medicosList');
    const dlObr = document.getElementById('obrasList');
    MEDICOS.forEach(v=>{ const o=document.createElement('option'); o.value=v; dlMed.appendChild(o); });
    OBRAS.forEach(v=>{ const o=document.createElement('option'); o.value=v; dlObr.appendChild(o); });

    // === Utilidad: convertir archivo a base64 (como ya usabas) ===
    function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=>{ const s=String(r.result); resolve(s.slice(s.indexOf(',')+1)); };
        r.onerror = reject; r.readAsDataURL(file);
      });
    }
  </script>

  <!-- === NUEVO: Adaptador hacia el backend Django (sin cambiar tu payload) === -->
  <script>
    async function sendToBackendFromPayload(p) {
      // El backend actual espera: apellido_nombre, dni, cobertura, estudio
      const piezas = [];
      if (p.medico)        piezas.push(`Médico: ${p.medico}`);
      if (p.email)         piezas.push(`Email: ${p.email}`);
      if (p.telefono)      piezas.push(`Teléfono: ${p.telefono}`);
      if (p.fecha_cx)      piezas.push(`Fecha cirugía: ${p.fecha_cx}`);
      if (p.observaciones) piezas.push(`Obs: ${p.observaciones}`);

      // Guardamos solo nombres de archivos por ahora (hasta activar storage real)
      if (p.orden_medica?.name)     piezas.push(`Orden médica: ${p.orden_medica.name}`);
      if (p.dni_file?.name)         piezas.push(`DNI: ${p.dni_file.name}`);
      if (p.credencial?.name)       piezas.push(`Credencial: ${p.credencial.name}`);
      if (p.orden_materiales?.name) piezas.push(`Orden materiales: ${p.orden_materiales.name}`);

      const body = {
        apellido_nombre: (p.nombre || '').trim(),
        dni: (p.dni || '').replace(/\D+/g, ''),     // solo números
        cobertura: (p.cobertura || '').trim(),
        estudio: piezas.join(' | ')
      };

      const r = await fetch(`${window.NEW_API_URL}/solicitudes`, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(body)
      });

      if (!r.ok) {
        const t = await r.text().catch(()=> '');
        throw new Error(t || 'Error enviando la solicitud al backend');
      }
    }
  </script>

  <script>
    // === Envío: JSON + base64 (tu flujo original), con switch hacia backend nuevo ===
    const form = document.getElementById('form');
    const btn  = document.getElementById('sendBtn');
    const MAX  = 15 * 1024 * 1024; // 15 MB por archivo

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();

      const f1 = form.orden_medica.files[0];
      const f2 = form.dni_file.files[0];
      const f3 = form.credencial.files[0];
      const f4 = form.orden_materiales.files[0]; // opcional

      if(!f1 || !f2 || !f3){ alert('Adjuntá la orden médica, DNI y credencial.'); return; }
      if(f1.size>MAX || f2.size>MAX || f3.size>MAX){ alert('Cada archivo debe pesar hasta 15 MB.'); return; }
      if(f4 && f4.size>MAX){ alert('La orden de materiales supera 15 MB.'); return; }

      btn.disabled = true; btn.textContent = 'Enviando…';
      try{
        const payload = {
          nombre: (form.nombre.value||'').trim(),
          dni: (form.dni.value||'').trim(),
          email: (form.email.value||'').trim(),
          telefono: (form.telefono.value||'').trim(),
          cobertura: (form.cobertura.value||'').trim(),
          medico: (form.medico.value||'').trim(),
          observaciones: (form.observaciones.value||'').trim(),
          fecha_cx: form.fecha_cx.value || "",
          // Archivos en base64 (solo para tu flujo actual a GS_URL)
          orden_medica: { name:f1.name, type:f1.type, base64: await fileToBase64(f1) },
          dni_file:     { name:f2.name, type:f2.type, base64: await fileToBase64(f2) },
          credencial:   { name:f3.name, type:f3.type, base64: await fileToBase64(f3) },
          orden_materiales: f4 ? { name:f4.name, type:f4.type, base64: await fileToBase64(f4) } : null
        };

        // === NUEVO: si está activo el backend, lo usamos y salimos
        if (window.USE_NEW_API) {
          await sendToBackendFromPayload(payload);
          window.location.href = '/Gracias.html';
          return;
        }

        // === Tu flujo original (Google Apps Script) — no tocado
        await fetch(GS_URL, {
          method:'POST',
          mode:'no-cors',                // evita problemas CORS, se redirige sin leer respuesta
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });

        // Redirección original (respetada)
        window.location.href = '/Gracias.html';
      }catch(err){
        alert('No se pudo enviar. Intentá de nuevo.\n'+(err && err.message ? err.message : err));
      }finally{
        btn.disabled = false; btn.textContent = 'Enviar solicitud';
      }
    });
  </script>
</body>
</html>
